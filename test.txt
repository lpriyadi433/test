-- Movement Menu Sederhana (Tanpa Rayfield)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")

-- Vars
local WalkSpeedEnabled = false
local CustomWalkSpeed = 16
local FlyEnabled = false
local FlySpeed = 100
local BodyGyro, BodyVelocity, FlyConn

-- Parent aman
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MovementMenu"
ScreenGui.ResetOnSpawn = false
if gethui then
    ScreenGui.Parent = gethui()
elseif syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
    ScreenGui.Parent = game.CoreGui
else
    ScreenGui.Parent = Player:WaitForChild("PlayerGui")
end

-- Frame utama
local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 320, 0, 260)
Frame.Position = UDim2.new(0.05, 0, 0.2, 0)
Frame.BackgroundColor3 = Color3.fromRGB(45,45,45)
Frame.BorderSizePixel = 0

-- Tombol Close (X)
local CloseBtn = Instance.new("TextButton", Frame)
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(1, -35, 0, 5)
CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.Font = Enum.Font.SourceSansBold
CloseBtn.TextScaled = true
CloseBtn.Text = "X"
CloseBtn.ZIndex = 2
CloseBtn.MouseButton1Click:Connect(function()
    -- Auto OFF semua fitur saat menu ditutup
    WalkSpeedEnabled = false
    Humanoid.WalkSpeed = 16
    if FlyEnabled then
        FlyEnabled = false
        if FlyConn then FlyConn:Disconnect() end
        if BodyVelocity then BodyVelocity:Destroy() end
        if BodyGyro then BodyGyro:Destroy() end
        Humanoid.PlatformStand = false
    end
    ScreenGui:Destroy()
end)

-- Judul
local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1,0,0,40)
Title.BackgroundColor3 = Color3.fromRGB(255,255,255)
Title.Text = "MENU PLAYER"
Title.Font = Enum.Font.SourceSansBold
Title.TextScaled = true
Title.TextColor3 = Color3.fromRGB(0,0,0)

-- === WalkSpeed ===
local WalkBtn = Instance.new("TextButton", Frame)
WalkBtn.Size = UDim2.new(0,80,0,30)
WalkBtn.Position = UDim2.new(0,10,0,60)
WalkBtn.Text = "OFF"
WalkBtn.BackgroundColor3 = Color3.fromRGB(255,49,93)
WalkBtn.TextColor3 = Color3.fromRGB(255,255,255)
WalkBtn.Font = Enum.Font.SourceSansBold
WalkBtn.TextScaled = true

local WalkLabel = Instance.new("TextLabel", Frame)
WalkLabel.Size = UDim2.new(0,150,0,30)
WalkLabel.Position = UDim2.new(0,100,0,60)
WalkLabel.BackgroundTransparency = 1
WalkLabel.Text = "WalkSpeed"
WalkLabel.TextColor3 = Color3.fromRGB(255,255,255)
WalkLabel.Font = Enum.Font.SourceSansBold
WalkLabel.TextScaled = true

-- Slider WalkSpeed
local WalkSliderFrame = Instance.new("Frame", Frame)
WalkSliderFrame.Size = UDim2.new(0,200,0,20)
WalkSliderFrame.Position = UDim2.new(0,10,0,100)
WalkSliderFrame.BackgroundColor3 = Color3.fromRGB(80,80,80)

local WalkFill = Instance.new("Frame", WalkSliderFrame)
WalkFill.Size = UDim2.new(CustomWalkSpeed/200,0,1,0)
WalkFill.BackgroundColor3 = Color3.fromRGB(0,200,0)

local WalkValue = Instance.new("TextLabel", Frame)
WalkValue.Size = UDim2.new(0,100,0,20)
WalkValue.Position = UDim2.new(0,220,0,100)
WalkValue.BackgroundTransparency = 1
WalkValue.Text = tostring(CustomWalkSpeed)
WalkValue.TextColor3 = Color3.fromRGB(255,255,255)
WalkValue.Font = Enum.Font.SourceSansBold
WalkValue.TextScaled = true

local draggingWalk = false
WalkSliderFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingWalk = true
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingWalk = false
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if draggingWalk and input.UserInputType == Enum.UserInputType.MouseMovement then
        local relX = math.clamp((input.Position.X - WalkSliderFrame.AbsolutePosition.X) / WalkSliderFrame.AbsoluteSize.X, 0, 1)
        CustomWalkSpeed = math.floor(relX * 200) -- max 200 speed
        WalkFill.Size = UDim2.new(relX,0,1,0)
        WalkValue.Text = tostring(CustomWalkSpeed)
        if WalkSpeedEnabled then
            Humanoid.WalkSpeed = CustomWalkSpeed
        end
    end
end)

-- === Fly ===
local FlyBtn = Instance.new("TextButton", Frame)
FlyBtn.Size = UDim2.new(0,80,0,30)
FlyBtn.Position = UDim2.new(0,10,0,140)
FlyBtn.Text = "OFF"
FlyBtn.BackgroundColor3 = Color3.fromRGB(255,49,93)
FlyBtn.TextColor3 = Color3.fromRGB(255,255,255)
FlyBtn.Font = Enum.Font.SourceSansBold
FlyBtn.TextScaled = true

local FlyLabel = Instance.new("TextLabel", Frame)
FlyLabel.Size = UDim2.new(0,150,0,30)
FlyLabel.Position = UDim2.new(0,100,0,140)
FlyLabel.BackgroundTransparency = 1
FlyLabel.Text = "Fly Player"
FlyLabel.TextColor3 = Color3.fromRGB(255,255,255)
FlyLabel.Font = Enum.Font.SourceSansBold
FlyLabel.TextScaled = true

-- Slider FlySpeed
local FlySliderFrame = Instance.new("Frame", Frame)
FlySliderFrame.Size = UDim2.new(0,200,0,20)
FlySliderFrame.Position = UDim2.new(0,10,0,180)
FlySliderFrame.BackgroundColor3 = Color3.fromRGB(80,80,80)

local FlyFill = Instance.new("Frame", FlySliderFrame)
FlyFill.Size = UDim2.new(FlySpeed/300,0,1,0) -- max 300
FlyFill.BackgroundColor3 = Color3.fromRGB(0,200,255)

local FlyValue = Instance.new("TextLabel", Frame)
FlyValue.Size = UDim2.new(0,100,0,20)
FlyValue.Position = UDim2.new(0,220,0,180)
FlyValue.BackgroundTransparency = 1
FlyValue.Text = tostring(FlySpeed)
FlyValue.TextColor3 = Color3.fromRGB(255,255,255)
FlyValue.Font = Enum.Font.SourceSansBold
FlyValue.TextScaled = true

local draggingFly = false
FlySliderFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingFly = true
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingFly = false
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if draggingFly and input.UserInputType == Enum.UserInputType.MouseMovement then
        local relX = math.clamp((input.Position.X - FlySliderFrame.AbsolutePosition.X) / FlySliderFrame.AbsoluteSize.X, 0, 1)
        FlySpeed = math.floor(relX * 300) -- max 300 speed
        FlyFill.Size = UDim2.new(relX,0,1,0)
        FlyValue.Text = tostring(FlySpeed)
    end
end)

-- === Functions ===
local function UpdateWalk()
    if WalkSpeedEnabled then
        Humanoid.WalkSpeed = CustomWalkSpeed
    else
        Humanoid.WalkSpeed = 16
    end
end

local function ToggleFly(state)
    FlyEnabled = state
    if FlyEnabled then
        local HRP = Character:WaitForChild("HumanoidRootPart")
        Humanoid.PlatformStand = true
        BodyGyro = Instance.new("BodyGyro", HRP)
        BodyGyro.MaxTorque = Vector3.new(9e9,9e9,9e9)
        BodyVelocity = Instance.new("BodyVelocity", HRP)
        BodyVelocity.MaxForce = Vector3.new(9e9,9e9,9e9)
        FlyConn = RunService.RenderStepped:Connect(function()
            local camCF = workspace.CurrentCamera.CFrame
            local move = Vector3.new()
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += camCF.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= camCF.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= camCF.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += camCF.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end
            BodyVelocity.Velocity = move.Magnitude > 0 and move.Unit * FlySpeed or Vector3.new()
            BodyGyro.CFrame = camCF
        end)
    else
        if FlyConn then FlyConn:Disconnect() end
        if BodyVelocity then BodyVelocity:Destroy() end
        if BodyGyro then BodyGyro:Destroy() end
        Humanoid.PlatformStand = false
    end
end

-- === Button Logic ===
WalkBtn.MouseButton1Click:Connect(function()
    WalkSpeedEnabled = not WalkSpeedEnabled
    WalkBtn.Text = WalkSpeedEnabled and "ON" or "OFF"
    WalkBtn.BackgroundColor3 = WalkSpeedEnabled and Color3.fromRGB(0,200,0) or Color3.fromRGB(255,49,93)
    UpdateWalk()
end)

FlyBtn.MouseButton1Click:Connect(function()
    FlyEnabled = not FlyEnabled
    FlyBtn.Text = FlyEnabled and "ON" or "OFF"
    FlyBtn.BackgroundColor3 = FlyEnabled and Color3.fromRGB(0,200,0) or Color3.fromRGB(255,49,93)
    ToggleFly(FlyEnabled)
end)

-- Respawn fix
Player.CharacterAdded:Connect(function(c)
    Character = c
    Humanoid = c:WaitForChild("Humanoid")
    UpdateWalk()
    if FlyEnabled then ToggleFly(true) end
end)

-- === Dragging Frame via Title ===
local dragging = false
local dragStart, startPos

local function updateDrag(input)
    local delta = input.Position - dragStart
    Frame.Position = UDim2.new(
        startPos.X.Scale, startPos.X.Offset + delta.X,
        startPos.Y.Scale, startPos.Y.Offset + delta.Y
    )
end

Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        updateDrag(input)
    end
end)
